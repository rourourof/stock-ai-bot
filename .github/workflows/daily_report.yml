name: Professional US Stock Report Bot

on:
  schedule:
    # -------------------------------------------------------------------------
    # GitHub ActionsはUTC（世界標準時）で記述します。
    # 日本時間 (JST) = UTC + 9時間
    # -------------------------------------------------------------------------
    
    # 1. 日本時間 朝 06:07 配信 (UTC 21:07 前日)
    # 00分は世界中のBotが動くため、あえて7分に設定してAPIエラーを回避します。
    - cron: '7 21 * * *'
    
    # 2. 日本時間 夕 18:07 配信 (UTC 09:07)
    - cron: '7 9 * * *'

  # 手動でいつでも実行可能にするボタンを追加
  workflow_dispatch:

jobs:
  stock-report-job:
    runs-on: ubuntu-latest
    
    # タイムアウト設定（長文生成を待つため30分に設定）
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          # yfinance等のライブラリ依存関係をキャッシュして高速化
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests newsapi-python discord-webhook yfinance pytz pandas

      - name: Run Market Analysis Bot
        env:
          # Settings -> Secrets and variables -> Actions で登録した名前と一致させてください
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: python main.py

      - name: Check for Failures
        if: failure()
        run: |
          echo "Bot execution failed. Please check the logs and OpenRouter API status."
